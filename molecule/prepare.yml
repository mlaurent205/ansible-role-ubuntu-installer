---
- name: prepare cache

  hosts: localhost

  connection: local

  vars_files:
    - vars.yml

  tasks:

    - name: create molecule cache dir
      file:
        path: "{{ cache_dir }}"
        owner: "{{ ansible_user }}"
        state: directory
      become: yes

    - name: test for presence of kvm key pair
      stat:
        path: "{{ kvm_key_pair_path }}"
      register: kvm_key_pair_local

    - name: create kvm key pair
      command: "ssh-keygen -t rsa -f {{ kvm_key_pair_path }} -q -P ''"
      when: not kvm_key_pair_local.stat.exists


- name: prepare networking

  hosts: all

  become: yes

  vars_files:
    - vars.yml

  tasks:

    - name: install python3
      apt:
        name: python3
        update_cache: yes

    - name: create dummy bridge
      command: "ip link add {{ bridge_name }} type bridge"
      failed_when: false

    - name: create dummy interface
      command: "ip link add {{ iface_name }} type dummy"
      failed_when: false

    - name: create dummy bridge slave
      command: "ip link set {{ iface_name }} master {{ bridge_name }}"
      failed_when: false

    - name: set bridge interface ip address
      command: "ip addr add {{ bridge_host }}/{{ bridge_prefix }} dev {{ bridge_name }}"
      failed_when: false

    - name: start bridge interface
      command: "ip link set dev {{ bridge_name }} up"
      failed_when: false

    - name: dnat ssh preroute
      iptables:
        table: nat
        chain: PREROUTING
        destination_port: "{{ (ssh_port_base | int) + (port_offset | int) }}"
        to_destination: "{{ item.ubuntu_installer_interface.ipaddress }}:22"
        jump: DNAT
        protocol: tcp
        state: present
      loop_control:
        index_var: port_offset
        label: "{{ item.ubuntu_installer_hostname }}"
      loop: "{{ vms }}"

    - name: dnat ssh output
      iptables:
        table: nat
        chain: OUTPUT
        destination_port: "{{ (ssh_port_base | int) + (port_offset | int) }}"
        to_destination: "{{ item.ubuntu_installer_interface.ipaddress }}:22"
        jump: DNAT
        protocol: tcp
        state: present
      loop_control:
        index_var: port_offset
        label: "{{ item.ubuntu_installer_hostname }}"
      loop: "{{ vms }}"

    - name: masquerade bridge
      iptables:
        table: nat
        chain: POSTROUTING
        out_interface: "{{ ansible_default_ipv4.interface }}"
        source: "{{ bridge_net }}"
        destination: 0.0.0.0/0
        jump: MASQUERADE
        protocol: all
        state: present

    - name: enable ipv4 forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
        reload: True

    - name: install kvm requirements
      apt:
        name:
          - qemu
          - qemu-kvm
          - qemu-efi
          - libvirt-clients
          - libvirt-daemon-system
          - libvirt-daemon-system-systemd
          - python3-libvirt

